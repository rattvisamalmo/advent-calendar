<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>R√§ttvisa Malm√∂ ‚Äî Advent Calendar</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=MuseoModerno:wght@300;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#faf8f3;
      --accent:#dd6031;
      --accent-2:#ffea94;
      --dark:#311e10;
      --white:#ffffff;
      --card-radius:14px;
      --shadow:0 20px 60px rgba(17,12,9,0.12);
      font-family:'Poppins', sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(135deg,var(--bg) 0%, var(--accent-2) 100%);font-family:'Poppins',sans-serif;}
    .container{width:100%;max-width:1400px;margin:0 auto;padding:40px 20px;}
    /* Snow canvas */
    #snow-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1; /* below cards */
    }

    .header{text-align:center;margin-bottom:40px}

    .header h1{
      font-family:'MuseoModerno';
      font-size:3em;
      margin:0 0 10px;
    }

    .header h1 .rattvisa {
      font-family: 'MuseoModerno';
      font-weight: 900;
      color: #dd6031;
    }

    .header h1 .malmo {
      font-family: 'MuseoModerno';
      font-weight: 300;
      color: #311e10;
    }

    .header p{font-size:1.1rem;color:#311e10;margin:0;font-style:italic}

    .calendar-grid{
      display:grid;
      grid-template-columns:repeat(6,1fr);
      gap:20px;
      margin-bottom:30px
    }

    @media(max-width:1024px){.calendar-grid{grid-template-columns:repeat(4,1fr)}}
    @media(max-width:768px){
      .calendar-grid{grid-template-columns:repeat(3,1fr);gap:12px}
    }
    @media(max-width:420px){.calendar-grid{grid-template-columns:repeat(2,1fr);gap:10px}}

    .door-container{perspective:1000px;aspect-ratio:1/1;position:relative}
    .door{width:100%;height:100%;position:relative;transform-style:preserve-3d;transition:transform 0.6s cubic-bezier(0.68,-0.55,0.265,1.55);cursor:pointer;border-radius:12px}
    .door.flipped .door-inner{transform:rotateY(180deg)}
    .door.locked{cursor:not-allowed}
    .door.shake{animation:shake 0.4s}

    @keyframes shake{
      0%{transform:translateX(0)}
      25%{transform:translateX(-6px)}
      50%{transform:translateX(6px)}
      75%{transform:translateX(-6px)}
      100%{transform:translateX(0)}
    }


    .tooltip{
      position:fixed;
      left:50%;
      transform: translateX(-50%);
      background:var(--dark);
      color:white;
      padding:8px 10px;
      font-size:0.8rem;
      border-radius:6px;
      opacity:0;
      pointer-events:none;
      transition:opacity .18s;
      white-space:nowrap;
      z-index: 9999;
    }
    .tooltip.show{opacity:1}

    .door-inner{width:100%;height:100%;transform-style:preserve-3d;transition:transform 0.6s cubic-bezier(0.68,-0.55,0.265,1.55)}
    .door-front,.door-back{position:absolute;inset:0;border-radius:12px;backface-visibility:hidden;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 28px rgba(0,0,0,0.12)}

    .door-front{background:linear-gradient(135deg,var(--accent) 0%, #ff8a5c 100%);border:3px solid var(--dark);}
    .door-number{font-size:2.2rem;font-weight:700;color:var(--white);text-shadow:1px 2px 6px rgba(0,0,0,0.25)}
    .door-sub{font-size:0.8rem;color:var(--white);opacity:0.95;margin-top:6px;padding: 12px;}
    .door-back{background:var(--white);transform:rotateY(180deg);padding:14px;border:3px solid var(--accent-2);}
    .door-back-content{font-size:0.9rem;color:var(--dark);text-align:center;overflow:hidden;padding: 12px;}

    .today {
      box-shadow: 0 0 30px 6px #7CFC00, 0 0 60px 12px #32CD32; /* larger pulsating green */
      animation: snow-glow-pulse 2s infinite ease-in-out;
    }

    @keyframes snow-glow-pulse {
      0%, 100% {
        box-shadow: 0 0 20px rgba(135, 206, 250, 0.6),
                    0 0 40px rgba(135, 206, 250, 0.4),
                    0 0 60px rgba(135, 206, 250, 0.2);
        filter: brightness(1);
      }
      50% {
        box-shadow: 0 0 30px rgba(135, 206, 250, 0.9),
                    0 0 60px rgba(135, 206, 250, 0.6),
                    0 0 90px rgba(135, 206, 250, 0.3);
        filter: brightness(1.15);
      }
    }

    /* Wiggle animation */
    @keyframes hat-wiggle {
      0% { transform: rotate(-45deg); }
      25% { transform: rotate(-35deg); }
      50% { transform: rotate(-50deg); }
      75% { transform: rotate(-40deg); }
      100% { transform: rotate(-45deg); }
    }

    /* Santa hat for today‚Äôs door */
    .door.today::before {
      content: '';
      position: absolute;
      top: -40px;
      left: -20px;
      width: 50px;
      height: 50px;
      background: url('https://upload.wikimedia.org/wikipedia/commons/c/c0/Santa_hat.svg') no-repeat center/contain;
      transform: rotate(-45deg);
      transform-origin: bottom right;
      pointer-events: none;
      z-index: 10;
      animation: hat-wiggle 1.5s ease-in-out infinite;
    }



    /* Wiggle animation for Santa hat */
    @keyframes wiggle {
      0%, 100% { transform: rotate(-45deg) translate(0,0); }
      25% { transform: rotate(-50deg) translate(-2px,-2px); }
      50% { transform: rotate(-40deg) translate(2px,2px); }
      75% { transform: rotate(-47deg) translate(-1px,1px); }
    }

    @keyframes pulseGlowGreen {
      0% { box-shadow: 0 0 15px 3px #7CFC00, 0 0 30px 6px #32CD32; }
      50% { box-shadow: 0 0 30px 6px #32CD32, 0 0 60px 12px #7CFC00; }
      100% { box-shadow: 0 0 15px 3px #7CFC00, 0 0 30px 6px #32CD32; }
    }



    .locked-overlay {
      position: absolute;
      inset: 0;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.45); /* frosted white */
      backdrop-filter: blur(4px); /* slight blur */
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none; /* prevent clicks on overlay itself */
    }

    .locked-overlay .lock {
      font-size: 2rem;
      color: var(--dark);
      opacity: 0.85;
      pointer-events: none; /* lock icon doesn‚Äôt catch clicks */
    }


    .modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(49,30,16,0.9);z-index:1000;align-items:center;justify-content:center;padding:20px}
    .modal-overlay.active{display:flex}
    @keyframes modalOpen {
      from {
        transform: scale(0.7);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }
    .modal-overlay.active .modal-content {
      animation: modalOpen 0.35s ease-out forwards;
    }

    
    .modal-content {
      background: #faf8f3;
      border-radius: 20px;
      padding: 50px;
      max-width: 700px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      position: relative;
      animation: modalOpen 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      max-height: 90%;
      overflow-y: auto;
      border: 15px solid;
      border-image: repeating-linear-gradient(
        45deg,
        #dc2626,
        #dc2626 20px,
        #ffffff 20px,
        #ffffff 40px,
        #16a34a 40px,
        #16a34a 60px,
        #ffffff 60px,
        #ffffff 80px
      ) 30;
    }

    /*.modal-content::before {
      content: 'üéÑ';
      position: absolute;
      top: -10px;
      left: 20px;
      font-size: 2.5em;
      z-index: 10;
    }
    
    .modal-content::after {
      content: 'üéÑ';
      position: absolute;
      top: -10px;
      right: 20px;
      font-size: 2.5em;
      z-index: 10;
    }*/

    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:16px;border-bottom:3px solid var(--accent-2)}
    .modal-day{font-size:2rem;color:var(--accent);font-weight:700}
    .close-btn{background:var(--accent);color:var(--white);border:none;width:44px;height:44px;border-radius:50%;font-size:1.4rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .25s}
    .close-btn:hover{background:var(--dark);transform:rotate(90deg)}

    .modal-text{font-size:1.05rem;color:var(--dark);line-height:1.6;margin:18px 0}

    .action-button{background:var(--accent);color:var(--white);border:none;padding:16px 28px;font-size:1.05rem;border-radius:999px;cursor:pointer;transition:all .25s;width:100%;font-weight:700;box-shadow:0 8px 24px rgba(221,96,49,0.22)}
    .action-button:hover{background:var(--dark);transform:translateY(-3px);box-shadow:0 12px 34px rgba(221,96,49,0.28)}

    .toast{position:fixed;left:50%;top:20%;transform:translateX(-50%);background:var(--accent);color:var(--white);padding:14px 22px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.25);z-index:2000}

    @media(max-width:768px){.header h1{font-size:2em}.modal-content{padding:24px}.modal-day{font-size:1.6rem}}

    .sparkle-particle {
      position: absolute;
      border-radius: 50%;
      pointer-events: none;
      z-index: 100;
      animation: sparkle-burst 1s ease-out forwards;
    }

    @keyframes sparkle-burst {
      0% {
        opacity: 1;
        transform: translate(0, 0) scale(1);
      }
      100% {
        opacity: 0;
        transform: translate(var(--tx), var(--ty)) scale(0);
      }
    }


    #loading-screen {
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(4px);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      font-size: 1.2rem;
      color: #333;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 5px solid #ccc;
      border-top-color: #e63946;
      border-radius: 50%;
      animation: spin 0.9s linear infinite;
      margin-bottom: 12px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

  </style>
</head>
<body>
  <!-- Snow canvas -->
  <canvas id="snow-canvas"></canvas>
  

  <div class="container">
    <div class="header">
      <h1><span class="rattvisa">r√§ttvisa</span> <span class="malmo">malm√∂</span></h1>
      <p>Adventskalender ‚Äî 24 dagar av handling f√∂r en b√§ttre stad</p>
    </div>

    <div class="calendar-grid" id="calendar-grid" aria-live="polite">
      <div id="loading-screen">
        <div class="spinner"></div>
          <p>H√§mtar dagens luckor‚Ä¶</p>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="modal-overlay" role="dialog" aria-modal="true">
    <div class="modal-content">
      <div class="modal-header"><div class="modal-day" id="modal-day">Dag 1</div><button class="close-btn" id="close-btn">√ó</button></div>
      <div class="modal-text" id="modal-text"></div>
      <button class="action-button" id="action-button"></button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    // ---- Diagonal Snow effect ----
    (function(){
      const canvas = document.getElementById('snow-canvas');
      const ctx = canvas.getContext('2d');
      let width = canvas.width = window.innerWidth;
      let height = canvas.height = window.innerHeight;

      window.addEventListener('resize', ()=>{
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
      });

      const flakes = [];
      const flakeCount = 8;
      for(let i=0; i<flakeCount; i++){
        flakes.push({
          x: Math.random() * width,
          y: Math.random() * height,
          r: Math.random() * 3 + 2,
          d: Math.random() + 1,
          tilt: Math.random() * 2,
          drift: Math.random() * 0.5 + 0.2 // slight horizontal drift
        });
      }

      function draw(){
        ctx.clearRect(0, 0, width, height);
        ctx.fillStyle = "rgba(255,255,255,0.9)";
        ctx.beginPath();
        for(let f of flakes){
          ctx.moveTo(f.x, f.y);
          ctx.arc(f.x, f.y, f.r, 0, Math.PI*2, true);
        }
        ctx.fill();
        update();
      }

      let angle = 0;
      function update(){
        angle += 0.01;
        for(let f of flakes){
          f.y += Math.pow(f.d, 1.5) + 0.5;
          f.x += Math.sin(angle) * f.d * 0.3 + f.drift;
          if(f.y > height){
            f.y = -f.r;
            f.x = Math.random() * width;
          }
          if(f.x > width) f.x = 0;
        }
      }

      function animate(){
        draw();
        requestAnimationFrame(animate);
      }

      animate();
    })();

  console.log("üîµ Script started.");

  /* ============================================================
     LOAD CALENDAR DATA FROM GOOGLE SHEET CSV
     ============================================================ */
  const CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vRtP7_COBqNFt8qdBndqcRNuLxp6a63p1p1IARXAgYVMxHUTNKXLAikdpwTyhLcEeHidDXMNKKYNXKB/pub?output=csv";

  console.log("üìÑ CSV URL:", CSV_URL);

  let calendarData = []; // Will be filled dynamically

  // dev toggle
  const devMode = true;
  const today = new Date();
  const currentDay = devMode ? 24 : (today.getMonth() === 11 ? today.getDate() : 0);
  console.log("üìÖ Current day:", currentDay);

  /* ============================================================
     FETCH + PARSE CSV ‚Üí Build calendarData[]
     ============================================================ */
  function loadCalendarData() {
    console.log("üîÑ Starting CSV load...");

    return new Promise((resolve, reject) => {
      Papa.parse(CSV_URL, {
        download: true,
        header: true,

        beforeFirstChunk: () => console.log("üì• Fetch initiated..."),

        complete: (results) => {
          console.log("‚úÖ CSV parse complete.");
          console.log("üìä Raw results:", results);

          if (!results || !results.data) {
            console.error("‚ùå No data returned from CSV!");
            reject("No data");
            return;
          }

          const rows = results.data;
          console.log("üìÑ Parsed rows:", rows);

          console.log("üîß Mapping rows to calendarData (auto day numbers)...");

          calendarData = rows.map((r, i) => {
            const mapped = {
              day: i + 1, // Auto-assign day number
              title: r.title || "",
              text: r.text || "",
              action: {
                type: r.action_type || "",
                url: r.action_url || "",
                to: r.action_to || "",
                subject: r.action_subject || "",
                body: r.action_body || "",
                script: r.action_script || "",
                // multi-recipient (mailto-multi)
                multi_to: r.action_to
                  ? r.action_to.split(/[;,]/).map((x) => x.trim()).filter(Boolean)
                  : [],
              },
            };

            console.log(`‚û°Ô∏è Row ${i + 1} mapped:`, mapped);
            return mapped;
          });

          console.log("üì¶ Final calendarData:", calendarData);

          resolve();
        },

        error: (err) => {
          console.error("‚ùå CSV parse error:", err);
          reject(err);
        },
      });
    });
  }

  /* ============================================================
     MAILTO BUILDER
     ============================================================ */
  function buildMailto(to, subject, body) {
    console.log("‚úâÔ∏è Building mailto link:", { to, subject, body });

    const safeTo = Array.isArray(to) ? to.join(",") : to || "";
    const parts = [];
    if (subject) parts.push("subject=" + encodeURIComponent(subject));
    if (body) parts.push("body=" + encodeURIComponent(body));
    return "mailto:" + safeTo + (parts.length ? "?" + parts.join("&") : "");
  }

  /* ============================================================
     UTILITY
     ============================================================ */
  function showToast(text) {
    console.log("üîî Toast:", text);
    const t = document.createElement("div");
    t.className = "toast";
    t.textContent = text;
    document.body.appendChild(t);
    setTimeout(() => {
      t.style.opacity = "0";
      t.addEventListener("transitionend", () => t.remove());
    }, 1800);
  }

  /* ============================================================
     RENDER CALENDAR
     ============================================================ */
  async function renderCalendar() {
    console.log("üöÄ Rendering calendar...");

    try {
      await loadCalendarData();
    } catch (err) {
      console.error("‚ùå Failed to load calendar data:", err);
      return;
    }

    console.log("üìÖ Data loaded. Count:", calendarData.length);

    const grid = document.getElementById("calendar-grid");
    console.log("üß± Calendar grid element:", grid);

    grid.innerHTML = "";
    console.log("üßπ Cleared calendar grid.");

    calendarData.forEach((item, index) =>{
      const container = document.createElement('div');
      container.className='door-container';

      const door = document.createElement('div');
      door.className='door';
      const inner = document.createElement('div');
      inner.className='door-inner';
      door.appendChild(inner);
      door.setAttribute('data-day', (index + 1));

      const front = document.createElement('div'); front.className='door-front';
      front.innerHTML=`<div style='text-align:center'><div class='door-number'>${(index + 1)}</div><div class='door-sub'>${item.title}</div></div>`;
      const back = document.createElement('div'); back.className='door-back';
      back.innerHTML=`<div class='door-back-content'>${item.title}</div>`;

      inner.appendChild(front); inner.appendChild(back);
      container.appendChild(door);

      const isUnlocked = (index + 1) <= currentDay && currentDay > 0;

      if(!isUnlocked){
        door.classList.add('locked');

        // add frosted overlay
        const overlay = document.createElement('div');
        overlay.className = 'locked-overlay';
        overlay.innerHTML = '<span class="lock">üîí</span>';
        door.appendChild(overlay);

        const tooltip = document.createElement('div');
        tooltip.className='tooltip';
        tooltip.textContent='L√•st - √∂ppnas p√• dag '+ (index + 1);
        document.body.appendChild(tooltip); // move tooltip to body

        container.addEventListener('mouseenter',()=>{
          const rect = container.getBoundingClientRect();
          tooltip.style.left = rect.left + rect.width/2 + 'px';
          tooltip.style.top = rect.bottom + 8 + 'px'; // 8px below the card
          tooltip.classList.add('show');
        });

        container.addEventListener('mouseleave',()=>{ tooltip.classList.remove('show'); });
        container.addEventListener('click', ()=>{ door.classList.add('shake'); tooltip.classList.add('show'); setTimeout(()=>{door.classList.remove('shake'); tooltip.classList.remove('show');},2000); });
      } else {
        if((index + 1) === currentDay) door.classList.add('today');
        container.addEventListener('click', ()=>{
          // Create sparkle burst
          const rect = container.getBoundingClientRect();
          const centerX = rect.left + rect.width / 2;
          const centerY = rect.top + rect.height / 2;
          
          // Create 15 sparkle particles
          for (let i = 0; i < 15; i++) {
            const sparkle = document.createElement('div');
            sparkle.className = 'sparkle-particle';
            
            // Random golden colors
            const goldColors = ['#FFD700', '#FFA500', '#FFED4E', '#FFBF00', '#FFE55C'];
            const color = goldColors[Math.floor(Math.random() * goldColors.length)];
            
            const size = Math.random() * 8 + 4;
            const angle = (Math.PI * 2 * i) / 15 + (Math.random() - 0.5) * 0.5;
            const distance = Math.random() * 80 + 40;
            const tx = Math.cos(angle) * distance;
            const ty = Math.sin(angle) * distance;
            
            sparkle.style.left = `${centerX}px`;
            sparkle.style.top = `${centerY}px`;
            sparkle.style.width = `${size}px`;
            sparkle.style.height = `${size}px`;
            sparkle.style.backgroundColor = color;
            sparkle.style.boxShadow = `0 0 ${size * 2}px ${color}`;
            sparkle.style.setProperty('--tx', `${tx}px`);
            sparkle.style.setProperty('--ty', `${ty}px`);
            
            document.body.appendChild(sparkle);
            
            setTimeout(() => sparkle.remove(), 1000);
          }

          door.classList.add('flipped');
          setTimeout(()=>{
            openModal(item, (index + 1));
          },400);
        });
      }

      container.tabIndex=0;
      grid.appendChild(container);
    });

    console.log("üèÅ Finished rendering.");
    document.getElementById("loading-screen").style.display = "none";
  }

  /* ============================================================
     MODAL LOGIC
     ============================================================ */
  const modalOverlay = document.getElementById("modal-overlay");
  const modalDay = document.getElementById("modal-day");
  const modalText = document.getElementById("modal-text");
  const actionButton = document.getElementById("action-button");
  const closeBtn = document.getElementById("close-btn");

  function openModal(item, day) {
    console.log("üì¨ Opening modal for day:", day, item);

    modalDay.textContent = "Dag " + day;
    modalText.innerHTML = item.text;

    const a = item.action;
    console.log("üõ†Ô∏è Action:", a);

    actionButton.style.display = "block";

    modalDay.textContent = 'Dag '+ day;
    modalText.textContent = item.text;
    
    // set action button text
    if(item.action.type === 'mailto' || item.action.type === 'mailto-multi') actionButton.textContent = 'Skicka mejl';
    else if(item.action.type === 'share') actionButton.textContent = 'Dela vidare';
    else if(item.action.type === 'link') actionButton.textContent = '√ñppna l√§nk';
    else if(item.action.type === 'quiz') actionButton.textContent = 'Starta quiz';
    else if(item.action.type === 'copy') actionButton.textContent = 'Kopiera l√§nk';
    else if(item.action.type === 'download') actionButton.textContent = 'Ladda ner';
    else if(item.action.type === 'call') actionButton.textContent = 'Se manus';
    else if(item.action.type === 'dm') actionButton.textContent = 'Kopiera DM';
    else if(item.action.type === 'video') actionButton.textContent = 'Se video';
    else actionButton.textContent = item.title;

    actionButton.onclick = () => {
      console.log("‚ñ∂Ô∏è Action button clicked:", a);

      switch (a.type) {
        case "share":
          if (!tryShare(a.url)) {
            navigator.clipboard.writeText(a.url);
            showToast("L√§nk kopierad!");
          }
          break;

        case "link":
        case "video":
        case "download":
        case "quiz":
        case 'video':
        case 'social_comment':
          window.open(a.url, "_blank");
          break;

        case "mailto":
          window.location.href = buildMailto(a.to, a.subject, a.body);
          break;

        case "mailto-multi":
          window.location.href = buildMailto(a.multi_to, a.subject, a.body);
          break;

        case 'copy':
          navigator.clipboard.writeText(item.action.text).then(()=> showToast('L√§nk kopierad till urklipp.'));
          break;
        
        case 'dm':
          navigator.clipboard.writeText(item.action.text).then(()=> showToast('DM kopierad till urklipp.'));
          break;

        case "call":
          alert(a.script || "Ring ditt korta manus!");
          break;

        case 'poll':
          showToast('Delta i en snabb enk√§t (l√§nk √∂ppnas).');
          break;

        case 'ugc':
          showToast('Dela din korta anledning och tagga kampanjen.');
          break;

        case 'offline':
          showToast('Prata med en v√§n ‚Äî tack!');
          break;

        default:
          showToast('Aktivitet utf√∂rd ‚Äî tack!');
      }
    };

    modalOverlay.classList.add("active");
  }

  closeBtn.addEventListener("click", () => {
    console.log("‚ùå Modal closed.");
    modalOverlay.classList.remove("active");
  });

  /* ============================================================
     INIT
     ============================================================ */
  console.log("üèÅ INIT ‚Üí calling renderCalendar()");
  renderCalendar();
  </script>


</body>
</html>
